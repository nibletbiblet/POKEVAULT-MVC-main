<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Font: Montserrat (Gotham-like) -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="/theme.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>Supermarket App - Cart</title>
  <style>
    .btn-primary.btn-cta {
      background: #ffffff;
      color: #000 !important;
      font-weight: 600;
      letter-spacing: .03em;
      border-radius: 0.35rem;
      border: 1px solid #ffffff;
      transition: 200ms ease-in-out;
      text-transform: uppercase;
      margin-top: 0.5rem;
    }

    .btn-primary.btn-cta:hover {
        background: #e6e6e6;
        color: #000;
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(255,255,255,0.35);
      }

    body {
background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-color: #111213;
      color: #fff;
      font-family: 'Montserrat', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      pointer-events: none;
      z-index: 0;
    }
    .custom-navbar { background-color: transparent !important; padding-top:1.05rem; padding-bottom:1.05rem; min-height:80px; z-index:1030; }

    .table-card {
      margin-top: 1.5rem;
      background: linear-gradient(150deg, rgba(12, 20, 34, 0.92), rgba(7, 12, 24, 0.96));
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      border-radius: 1rem;
      padding: 1rem 1.2rem;
      color: #ffffff;
      border: 1px solid rgba(88,166,255,0.25);
      box-shadow: 0 18px 40px rgba(0,0,0,0.5);
      overflow: hidden;
    }

    .table-card thead th,
    .table-card tbody td {
      color: #ffffff;
      background: transparent;
      vertical-align: middle;
      font-weight: 600;
    }

    .product-image { max-height:64px; border-radius: 0.35rem; object-fit: cover; }

    .table-card table { border-collapse: separate; border-spacing: 0; }
    .table-card thead th { background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03)); padding: 0.6rem 0.75rem; }
    .table-card thead th:first-child { border-top-left-radius: 0.6rem; }
    .table-card thead th:last-child { border-top-right-radius: 0.6rem; }

    /* Small circular remove button in cart rows */
    .remove-btn {
      width: 34px;
      height: 34px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: #fff;
      padding: 0;
      font-weight: 700;
      line-height: 1;
      cursor: pointer;
    }
    .remove-btn:hover { background: rgba(220,53,69,0.18); color: #fff; box-shadow: 0 8px 18px rgba(220,53,69,0.28); }

    .cart-hero {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      padding: 1.6rem 1.8rem;
      border-radius: 1.1rem;
      background: radial-gradient(120% 140% at 10% 10%, rgba(88,166,255,0.18), transparent 60%),
        linear-gradient(135deg, rgba(7,12,20,0.92), rgba(7,10,18,0.98));
      border: 1px solid rgba(88,166,255,0.25);
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
    }
    .cart-hero::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(115deg, rgba(0,0,0,0) 0%, rgba(17,170,255,0.18) 50%, rgba(0,0,0,0) 100%);
      mix-blend-mode: screen;
      opacity: 0.65;
      pointer-events: none;
    }
    .cart-hero-text {
      position: relative;
      z-index: 1;
    }
    .cart-kicker {
      text-transform: uppercase;
      letter-spacing: 0.2em;
      font-size: 0.65rem;
      color: rgba(233,236,239,0.7);
      font-weight: 700;
    }
    .cart-title {
      font-size: clamp(1.6rem, 2.2vw, 2.2rem);
      font-weight: 800;
      margin: 0.2rem 0;
    }
    .cart-sub {
      color: rgba(233,236,239,0.75);
      margin: 0;
    }
    .cart-hero img {
      width: 92px;
      height: 92px;
      object-fit: contain;
      filter: drop-shadow(0 12px 24px rgba(0,0,0,0.55));
      position: relative;
      z-index: 1;
    }

    .brand-logo {
      font-family: 'Montserrat', system-ui, sans-serif;
      display: inline-flex;
      flex-direction: column;
      text-align: center;
      text-decoration: none;
      line-height: 1.05;
      padding-left: 0.1rem;
    }

    .brand-main {
      font-size: 1.45rem;
      font-weight: 700;
      letter-spacing: 0.33em;
      text-transform: uppercase;
      color: #ffffff;
    }

    .brand-sub {
      font-size: 0.68rem;
      font-weight: 500;
      letter-spacing: 0.28em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.75);
      margin-top: 0.15rem;
    }

    footer.site-footer { background:#0b0c0d; color:#fff; padding:2.5rem 0; border-top:1px solid rgba(255,255,255,0.03); }
    a, .nav-link { color: rgba(255,255,255,0.95); }

    /* Toast notification styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
    }
    .toast-notification {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      color: #000000;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      margin-bottom: 0.75rem;
      animation: slideIn 300ms ease-out, slideOut 300ms ease-out 2700ms forwards;
      border: 1px solid rgba(255,255,255,0.1);
      font-weight: 500;
    }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
  </style>
</head>
<body class="theme-gradient d-flex flex-column min-vh-100">
  <div class="toast-container" id="toastContainer"></div>
  <a class="visually-hidden-focusable" href="#main-content">Skip to main content</a>
  <nav class="navbar navbar-expand-sm navbar-dark bg-dark custom-navbar">
    <div class="container-fluid" role="navigation" aria-label="Main navigation">
      <a class="navbar-brand brand-logo" href="/">
        <span class="brand-main">PokeVault</span>
        <span class="brand-sub">SINGAPORE</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar" aria-controls="collapsibleNavbar" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="collapsibleNavbar">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item d-flex align-items-center me-3">
            <span class="text-light small">Signed in as <strong><%= user.username %></strong></span>
          </li>
          <li class="nav-item me-2"><a class="btn btn-outline-light btn-sm btn-cta btn-minimal" href="/orders">My Orders</a></li>
          <li class="nav-item me-2"><a class="btn btn-outline-light btn-sm btn-cta btn-minimal" href="/shopping">Continue Shopping</a></li>
          <li class="nav-item"><a class="btn btn-outline-light btn-sm btn-cta btn-minimal" href="/logout">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main id="main-content" class="container flex-grow-1 py-4" role="main">
    <div class="cart-hero">
      <div class="cart-hero-text">
        <div class="cart-kicker">Trainer hub</div>
        <div class="cart-title">Your Cart</div>
        <p class="cart-sub">Review your deck picks and keep trades ready for checkout.</p>
      </div>
      <img src="/images/ultra_ball.png" alt="Ultra Ball">
    </div>
    <div class="table-card">
      <% if (!cart || cart.length === 0) { %>
        <p style="color: #fff;">Your cart is empty.</p>
        <a class="btn btn-outline-light" href="/shopping">Browse items</a>
      <% } else { %>
        <div class="table-responsive">
          <table class="table table-hover small text-center mb-0">
            <thead>
              <tr>
                <th style="width:48px"></th>
                <th>Product</th>
                <th>Rarity</th>
                <th>Image</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <% let total = 0; %>
              <% for (let i = 0; i < cart.length; i++) { %>
                <% const itemId = cart[i].id || cart[i].productId; %>
                <tr>
                  <td>
                    <form action="/remove-from-cart/<%= itemId %>" method="POST" class="remove-item-form" data-name="<%= cart[i].productName %>">
                      <button type="submit" class="remove-btn" title="Remove">x</button>
                    </form>
                  </td>
                  <td><a href="/product/<%= itemId %>"><%= cart[i].productName %></a></td>
                  <td><%= cart[i].rarity || cart[i].category || '-' %></td>
                  <td><img class="product-image" src="/images/<%= cart[i].image %>" alt="<%= cart[i].productName %>" /></td>
                  <td>
                    <% if (cart[i].discountPercent && Number(cart[i].discountPercent) > 0) { %>
                      <div>
                        <span style="text-decoration: line-through; color: #ff6b6b; font-size: 0.9rem;">$<%= Number(cart[i].originalPrice || cart[i].price).toFixed(2) %></span>
                        <span class="ms-1">$<%= Number(cart[i].price).toFixed(2) %></span>
                      </div>
                      <small class="text-white-50">-<%= Number(cart[i].discountPercent).toFixed(2) %>%</small>
                    <% } else { %>
                      $<%= Number(cart[i].price).toFixed(2) %>
                    <% } %>
                  </td>
                  <td>
                    <form action="/update-cart/<%= itemId %>" method="POST" class="d-inline-flex align-items-center justify-content-center gap-2 update-item-form" data-name="<%= cart[i].productName %>">
                      <input type="number" name="quantity" value="<%= cart[i].quantity %>" min="1" class="form-control form-control-sm text-center" style="width:80px">
                      <button type="submit" class="btn btn-outline-light btn-sm">Update</button>
                    </form>
                  </td>
                  <td>$<%= (cart[i].price * cart[i].quantity).toFixed(2) %></td>
                </tr>
                <% total += cart[i].price * cart[i].quantity; %>
              <% } %>
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
          <div>
            <a class="btn btn-outline-light" href="/shopping">Continue Shopping</a>
            <form action="/clear-cart" method="POST" class="d-inline-block ms-2 clear-cart-form">
              <button type="submit" class="btn btn-outline-danger">Clear Cart</button>
            </form>
          </div>
          <div class="text-end">
            <h5 class="mb-1 text-white fw-bold">Total: $<%= total.toFixed(2) %></h5>
            <a class="btn btn-primary btn-cta" href="/checkout">Proceed to Checkout</a>
          </div>
        </div>
      <% } %>
    </div>
  </main>

<script>
  // Toast helper
  function showToast(message) {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3200);
  }

  // AJAX helpers for cart CRUD
  (function() {
    const removeForms = Array.from(document.querySelectorAll('.remove-item-form'));
    removeForms.forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = form.dataset.name || 'item';
        if (!confirm(`Remove ${name} from cart?`)) return;
        try {
          const res = await fetch(form.action, { method: 'POST' });
          if (!res.ok) throw new Error('Remove failed');
          showToast(`${name} removed from cart`);
          setTimeout(() => window.location.reload(), 600);
        } catch (err) {
          console.error(err);
          showToast('Could not remove item. Please try again.');
        }
      });
    });

    const updateForms = Array.from(document.querySelectorAll('.update-item-form'));
    updateForms.forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const name = form.dataset.name || 'item';
        try {
          const res = await fetch(form.action, { method: 'POST', body: new URLSearchParams(formData) });
          if (!res.ok) throw new Error('Update failed');
          showToast(`${name} quantity updated`);
          setTimeout(() => window.location.reload(), 600);
        } catch (err) {
          console.error(err);
          showToast('Could not update quantity. Please try again.');
        }
      });
    });

    const clearForm = document.querySelector('.clear-cart-form');
    if (clearForm) {
      clearForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!confirm('Clear all items from your cart?')) return;
        try {
          const res = await fetch(clearForm.action, { method: 'POST' });
          if (!res.ok) throw new Error('Clear failed');
          showToast('Cart cleared');
          setTimeout(() => window.location.reload(), 600);
        } catch (err) {
          console.error(err);
          showToast('Could not clear cart. Please try again.');
        }
      });
    }
  })();
</script>

<footer class="site-footer mt-auto">
  <div class="container text-center">
    <p class="mb-1">Connecting Pokémon card collectors worldwide — shop, sell, and trade in a safe and growing community.</p>
    <small class="small">© <%= new Date().getFullYear() %> PokéVault. All rights reserved.</small>
  </div>
</footer>
</body>
</html>
